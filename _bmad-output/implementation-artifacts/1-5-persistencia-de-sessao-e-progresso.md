<!-- Generated by create-story (manual, local-only pivot) -->
# Story 1.5: Persistência de Sessão e Progresso (modo local)

Status: done

## Story

As a user,
I want my session and progress to be saved between visits,
so that I don't lose my learning progress when I return to the platform.

## Acceptance Criteria

1. **Given** I have logged in previously  
   **When** I return to the application  
   **Then** my local session should be automatically restored if still valid  
   **And** my local progress data should be loaded from browser storage  
   **And** I should be redirected to the dashboard if session is valid  
   **And** if the session is cleared, I should be redirected to login page  
   **And** progress data should be persisted locally without any network dependency

## Tasks / Subtasks

- [x] Task 1: Sessão local com validade + restore (AC: 1)
  - [x] Introduzir validade de sessão (ex.: `expiresAt`) e validação no `getSession()`
  - [x] Garantir que `/login` redireciona para `/dashboard` quando já existe sessão válida

- [x] Task 2: Progresso local carregado no boot (AC: 1)
  - [x] Garantir que o perfil/progresso local do usuário seja “ensure/load” na entrada do app (ex.: ao acessar `/dashboard`)

- [x] Task 3: Testes e validações (AC: 1)
  - [x] Testes unitários para restore/expiração da sessão e carregamento de perfil/progresso
  - [x] `npm test`
  - [x] `npm run lint`
  - [x] `npm run build`

## Dev Notes

### Regras/Restrições do projeto (modo local)

- **Sem serviços externos** no MVP.
- Sessão atual: `src/lib/auth.ts` (localStorage + fallback memória).
- Perfil/progresso atual: `src/lib/profile.ts` em `localStorage`, usuário estável `"lia"`.

### Source tree components to touch

- `src/lib/auth.ts`
- `src/pages/Login.tsx`
- `src/pages/Dashboard.tsx`
- `src/lib/profile.ts`
- `src/lib/auth.test.ts`
- `src/lib/profile.test.ts`

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Agent)

### Debug Log References

N/A

### Completion Notes List

- ✅ Sessão local agora tem validade (`expiresAt`) e é restaurada automaticamente quando válida (`src/lib/auth.ts`)
- ✅ `/login` redireciona para `/dashboard` se já existir sessão válida (`src/pages/Login.tsx`)
- ✅ Progresso local (perfil) é carregado no boot via `ensureProfile` no Dashboard (`src/pages/Dashboard.tsx`)
- ✅ Testes: expiração de sessão + perfil idempotente; validação `npm test/lint/build`
- ✅ Code-review fixes: persistência de update de progresso (`updateProfile` + `+1 XP`) e notificação em expiração de sessão
### File List

- src/lib/auth.ts
- src/lib/profile.ts
- src/pages/Login.tsx
- src/pages/Dashboard.tsx
- src/lib/auth.test.ts
- src/lib/profile.test.ts
- _bmad-output/implementation-artifacts/1-5-persistencia-de-sessao-e-progresso.md

## Senior Developer Review (AI)

**Review Date:** 2025-12-21  
**Review Outcome:** ✅ APPROVED (after fixes)

### Git vs Story Discrepancies

- **[INFO] Garanta commit**: este review presume que as mudanças serão commitadas para rastreabilidade por story.

### Issues Found (Adversarial)

**MEDIUM**
1. **Progresso carregado no Dashboard é exibido mas não há garantia de “update”/persistência de progresso**: o story fala “progress data”, porém só há leitura/ensure. Falta uma operação mínima (mesmo que de demonstração) para confirmar que mudanças persistem entre recarregamentos. ✅ **Corrigido**: `updateProfile()` + botão `+1 XP` e teste de persistência.
2. **Sessão expirada não notifica assinantes explicitamente**: `getSession()` limpa o storage quando expira, mas não dispara `notify(null)`. Usuários que dependam apenas do subscription podem ficar com estado stale até reload. ✅ **Corrigido**: expiração agora usa `setSession(null)` (notifica subscribers).

**LOW**
3. **LoginPage: redirecionamento imediato pode esconder erros**: se `getSession()` retornar sessão inválida/corrompida e `safeParseSession()` retornar null, ok; mas se houver sessão válida e o usuário quiser “relogin”, não há opção UI (aceitável para MVP, mas UX limitada).


