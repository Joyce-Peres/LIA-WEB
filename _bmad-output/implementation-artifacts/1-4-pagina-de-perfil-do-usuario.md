<!-- Generated by create-story (manual, local-only pivot) -->
# Story 1.4: Página de Perfil do Usuário (modo local)

Status: done

## Story

As a user,
I want to view my profile with my name, avatar, total XP, and current streak,
so that I can see my progress and achievements.

## Acceptance Criteria

1. **Given** I am logged in  
   **When** I navigate to `/profile`  
   **Then** I should see my display name as **"LIA"**  
   **And** I should see an avatar (generated locally)  
   **And** I should see my total XP (initially 0)  
   **And** I should see my current streak (initially 0)  
   **And** The data should be loaded from local storage in the browser  
   **And** If the profile doesn't exist, it should be created automatically on first login

## Tasks / Subtasks

- [x] Task 1: Perfil local (modelo + persistência) (AC: 1)
  - [x] Criar `src/lib/profile.ts` com `getProfile/ensureProfile` persistindo por usuário em `localStorage`
  - [x] Garantir criação automática do perfil no primeiro login (integrar com `src/lib/auth.ts`)

- [x] Task 2: Página `/profile` (UI + navegação) (AC: 1)
  - [x] Criar `src/pages/Profile.tsx` (rota protegida) exibindo: Nome "LIA", avatar, XP=0, streak=0
  - [x] Adicionar rota `/profile` em `src/App.tsx`
  - [x] Adicionar link no Dashboard para navegar para o perfil

- [x] Task 3: Validações (AC: 1)
  - [x] `npm run build`
  - [x] `npm run lint`

## Dev Notes

### Regras/Restrições do projeto (modo local)

- **Sem serviços externos** no MVP: não depender de Supabase/Google OAuth/Vercel/etc.
- **Sessão**: já existe `src/lib/auth.ts` (localStorage). Perfil deve se integrar a esse fluxo.

### Source tree components to touch

- `src/lib/auth.ts`
- `src/lib/profile.ts` (novo)
- `src/pages/Profile.tsx` (novo)
- `src/App.tsx`
- `src/pages/Dashboard.tsx`

### Testing standards summary

- Sem framework de testes configurado no repositório neste momento.
- Validação via:
  - `npm run build`
  - `npm run lint`

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Agent)

### Debug Log References

N/A

### Completion Notes List

- ✅ Perfil local criado automaticamente no primeiro login (`src/lib/profile.ts` + integração em `src/lib/auth.ts`)
- ✅ Página `/profile` adicionada e protegida (redireciona para `/login` sem sessão)
- ✅ Nome fixo “LIA”, avatar local e métricas iniciais XP=0 / streak=0
- ✅ Validação: `npm run build` e `npm run lint`
- ✅ Fixes do code-review: `userId` estável ("lia"), validação de storage, testes unitários com Vitest, try/catch para `localStorage`
### File List

- src/lib/profile.ts
- src/lib/auth.ts
- src/lib/profile.test.ts
- src/lib/auth.test.ts
- src/pages/Profile.tsx
- src/App.tsx
- src/pages/Dashboard.tsx
- _bmad-output/implementation-artifacts/1-4-pagina-de-perfil-do-usuario.md
- package.json
- package-lock.json

## Senior Developer Review (AI)

**Review Date:** 2025-12-21  
**Review Outcome:** ✅ APPROVED (after fixes)

### Git vs Story Discrepancies

- **[MEDIUM] Working tree tem mudanças além do escopo da Story 1.4**: o `git status --porcelain` mostra vários arquivos modificados/não rastreados (docs, epics, package-lock, etc.) que não estão listados nesta story. Isso prejudica auditoria por story e aumenta risco de regressão.
- **[MEDIUM] Arquivos da própria Story 1.4 ainda estão `??` (untracked)**: `src/lib/profile.ts`, `src/pages/Profile.tsx` e este story file aparecem como não rastreados. Sem commit, não há rastreabilidade/reprodutibilidade do review.

### Acceptance Criteria Validation (AC: 1)

- `/profile` existe e é rota protegida (redireciona para `/login` sem sessão): `src/pages/Profile.tsx` (verifica `getSession()` e navega).
- Nome “LIA”, avatar e XP/streak iniciais 0 são exibidos: `src/lib/profile.ts` + `src/pages/Profile.tsx`.
- Criação automática do perfil no primeiro login: `src/lib/auth.ts` chama `ensureProfile(session.user.id)`.

### Issues Found (Adversarial)

**MEDIUM**
1. **Identidade do “usuário” não é estável entre logins**: `signInLocal()` gera `id` aleatório (`randomId()` em `src/lib/auth.ts`), então ao fazer logout/login de novo, o app cria um *novo* perfil (key muda) e o histórico anterior fica órfão no `localStorage`. Para um MVP local com nome fixo “LIA”, o esperado é um `userId` constante (ex.: `"lia"`). ✅ **Corrigido**: `userId` agora é estável (`"lia"`).
2. **Validação fraca de dados do storage**: `safeParseSession()` e `safeParseProfile()` só checam presença de chaves e fazem cast direto. Se `localStorage` estiver corrompido/manipulado, pode quebrar UI (ex.: `profile.totalXp` não ser número). Falta normalização/validação mínima e fallback. ✅ **Corrigido**: validação/normalização mínima adicionada (tipos e números finitos).
3. **Sem testes automatizados**: a story declara “Sem framework de testes”, então não dá para garantir regressões (rota protegida, criação do perfil, persistência). Mesmo um teste mínimo (unit) para `ensureProfile()` ajudaria. ✅ **Corrigido**: testes unitários mínimos adicionados com Vitest (auth/profile).

**LOW**
4. **Sem tratamento para exceções de `localStorage`** (quota/blocked/private mode): `localStorage.setItem` pode lançar; hoje isso falha silenciosamente no fluxo (sem mensagem para o usuário). ✅ **Corrigido (parcial)**: operações de storage agora são protegidas com try/catch; sessão tem fallback em memória.

