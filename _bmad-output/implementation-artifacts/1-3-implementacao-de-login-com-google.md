<!-- Generated by create-story (manual run) -->
# Story 1.3: Implementação de Login com Google

Status: in-progress

## Story

As a user,
I want to log in with my Google account,
so that I can access the LIA Web platform and have my progress saved.

## Acceptance Criteria

1. **Given** I am on the login page  
   **When** I click "Login with Google"  
   **Then** I should be redirected to Google OAuth consent screen  
   **And** After granting permissions, I should be redirected back to the application  
   **And** My user session should be established  
   **And** I should be redirected to the dashboard  
   **And** If authentication fails, an appropriate error message should be displayed

## Tasks / Subtasks

- [x] Task 1: Routing for auth flow (AC: 1)
  - [x] Add React Router routes for `/login`, `/auth/callback`, `/dashboard` (`src/App.tsx`)
  - [x] Redirect `/` to `/dashboard` (and to `/login` when logged out) (`src/App.tsx`, `src/pages/Dashboard.tsx`)

- [x] Task 2: Login UI + Supabase OAuth call (AC: 1)
  - [x] Create `src/pages/Login.tsx` with "Login com Google" button
  - [x] Implement `supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo } })`
  - [x] Show a clear error message when the auth call fails

- [x] Task 3: OAuth callback handling + session establishment (AC: 1)
  - [x] Create `src/pages/AuthCallback.tsx` to exchange auth code for session (PKCE) and redirect to `/dashboard`
  - [x] Handle error states (invalid code, exchange failure)

- [x] Task 4: Protected dashboard stub (AC: 1)
  - [x] Create `src/pages/Dashboard.tsx` (minimal)
  - [x] If no session, redirect to `/login`

## Dev Notes

### Relevant architecture patterns and constraints

- **Auth provider**: Supabase Auth (Google). No custom backend.
- **Env vars**: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY` must be present (fail-fast is acceptable).
- **No offline mode**: requires active connection for auth and sync.

### Source tree components to touch

- `package.json` (add `react-router-dom`)
- `src/App.tsx` (router + session gate)
- `src/pages/Login.tsx`
- `src/pages/AuthCallback.tsx`
- `src/pages/Dashboard.tsx`
- `src/lib/supabase.ts` (already exists)

### Testing standards summary

- No tests required for this story at this stage. Validation via:
  - `npm run build`
  - `npm run lint`
  - `npx tsc --noEmit`

### References

- `_bmad-output/epics.md#Story 1.3` (ACs)
- `docs/supabase-setup.md` (manual Google OAuth setup)

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Agent)

### Debug Log References

N/A

### Completion Notes List

- ✅ Added routing and pages: `/login`, `/auth/callback`, `/dashboard`
- ✅ Implemented Supabase Google OAuth redirect + PKCE code exchange
- ✅ Implemented session gate (redirect to login if no session) and logout
- ✅ Verified: `npm run build`, `npm run lint`, `npx tsc --noEmit`
- ⚠️ End-to-end validation depends on completing Supabase Google OAuth manual setup (see `docs/supabase-setup.md`)

### File List

- package.json
- package-lock.json
- src/App.tsx
- src/pages/Login.tsx
- src/pages/AuthCallback.tsx
- src/pages/Dashboard.tsx

## Senior Developer Review (AI)

**Review Date:** 2025-12-21  
**Review Outcome:** ❌ CHANGES REQUESTED

### Git vs Story Discrepancies

- **[MEDIUM] Git baseline not established**: `git status --porcelain` shows most of the repo as `??` (untracked). This prevents clean story-level change auditing until an initial baseline commit exists.

### Acceptance Criteria Validation

- **Redirect to Google consent screen**: Implemented via `supabase.auth.signInWithOAuth` (`src/pages/Login.tsx`), but **cannot be verified end-to-end** until Google provider is enabled in Supabase (Story 1.2 manual setup).
- **Redirect back + session established**: Implemented via `supabase.auth.exchangeCodeForSession(code)` (`src/pages/AuthCallback.tsx`), but **blocked** until OAuth setup is completed.
- **Redirect to dashboard**: Implemented (`src/App.tsx` + `src/pages/Dashboard.tsx`).
- **Error message on failure**: Implemented (`src/pages/Login.tsx` + `src/pages/AuthCallback.tsx`).

### Issues Found

**HIGH**
1. **E2E auth is blocked by external setup**: Story 1.3 should not be considered “done” until Google OAuth is actually enabled and the flow is validated in a real Supabase project.

**MEDIUM**
2. **No “returnTo/next” support**: If user is redirected to `/login` from a protected route, the app does not preserve the original destination for post-login redirect.
3. **Hard-coded redirectTo origin**: `redirectTo = ${window.location.origin}/auth/callback` may break in subpath deployments. Consider making this configurable or using a known site URL.

**LOW**
4. **Missing friendly env error screen**: env fail-fast throws in `src/lib/supabase.ts` (by design), but UX could be improved by showing a readable screen when env vars are missing.

### Recommended Next Actions

1. Finish Story 1.2 manual setup using `docs/supabase-setup.md` (Google provider + redirect URIs + env vars).
2. Optional polish:
   - Add `next` query param handling for better UX.
   - Add a simple env-missing page instead of hard crash.

