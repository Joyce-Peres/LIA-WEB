<div class="practice-page" *ngIf="!isLoading(); else loadingTpl">
  <div class="header">
    <button class="btn back-btn-primary back-btn" (click)="backToLesson()">Voltar</button>
    <div class="header-title">
      <div class="title-wrapper">
        <div class="page-title">Prática</div>
        <span class="title-accent"></span>
      </div>
      <div class="page-subtitle">{{ lesson()?.displayName }}</div>
    </div>
    <div class="spacer"></div>
    <app-user-menu></app-user-menu>
  </div>

  <div class="layout">
    <div class="camera-panel soft-card soft-card--spacious">
      <div class="camera-box" [class.ready]="cameraReady()">
        <video #videoEl class="video" [class.unmirrored]="settings.unmirrorCamera()" autoplay playsinline muted></video>
        <canvas #overlayEl class="overlay" [class.unmirrored]="settings.unmirrorCamera()"></canvas>
      </div>
      <div class="hands-missing" [class.is-hidden]="!handsMissingVisible()">
        <span class="label">Mãos não detectadas</span>
      </div>
      <div class="hint">Mantenha as mãos dentro da área visível e siga as instruções.</div>
      <div class="camera-actions">
        <label class="select-label">Câmera:</label>
        <select class="select" [(ngModel)]="cameraSelectValue" (change)="onCameraSelectionChange()">
          <option value="facing:user">Frontal</option>
          <option value="facing:environment">Traseira</option>
          <optgroup label="Dispositivos">
            <option *ngFor="let d of availableCameras()" [value]="'device:' + d.deviceId">{{ d.label }}</option>
          </optgroup>
        </select>
        <button class="btn primary action-btn" (click)="cameraReady() ? stopCamera() : initCamera()">
          {{ cameraReady() ? 'Parar câmera' : 'Iniciar câmera' }}
        </button>
        <button class="btn ghost" (click)="changeCamera()" [disabled]="!cameraReady()">Trocar câmera</button>
      </div>
    </div>

    <div class="info-panel soft-card soft-card--spacious">
      <h1 class="title">{{ lesson()?.displayName }}</h1>
      <p class="module">Módulo: {{ lesson()?.module?.title }}</p>
      <div class="chips">
        <span class="badge badge-neutral">Gesto: {{ lesson()?.gestureName }}</span>
        <span class="badge badge-neutral">Nível {{ lesson()?.level }}</span>
        <span class="badge badge-success">XP {{ lesson()?.xpReward }}</span>
        <span class="badge badge-neutral">Confiança mínima {{ (lesson()?.minConfidenceThreshold ?? 0) * 100 | number:'1.0-0' }}%</span>
      </div>

      <!-- Video de referência (compacto) -->
      <div class="reference-video">
        <app-gesture-video-player
          [src]="lesson()?.videoRefUrl"
          [gesture]="lesson()?.gestureName"
          [loopVideo]="true"
          [autoplayVideo]="false"
        ></app-gesture-video-player>
      </div>

      <!-- Recognition status -->
      <div
        class="recognition-status soft-card soft-card--compact"
        [class.is-inactive]="!isSessionActive()"
        [attr.aria-hidden]="!isSessionActive()"
      >
        @if (isSessionActive()) {
          <div class="recognition-row">
            <span class="label">Gesto detectado:</span>
            <span class="value" [class.correct]="gesturesMatch(recognizedGesture(), lesson()?.gestureName)">
              {{ recognizedGesture() || '—' }}
            </span>
          </div>
          <div class="recognition-row">
            <span class="label">Buffer:</span>
            <span class="value">{{ bufferProgress() }}/30 frames</span>
          </div>
          <div class="recognition-row">
            <span class="label">FPS inferência:</span>
            <span class="value">{{ recognitionFps() }}</span>
          </div>
        }
      </div>

      <div class="session-controls">
        <button class="btn primary action-btn" (click)="isSessionActive() ? stopSession() : startSession()">
          {{ isSessionActive() ? 'Parar prática' : 'Iniciar prática' }}
        </button>
        <span class="status">{{ practiceStatus() }}</span>
      </div>

      <div class="meters">
        <div class="meter">
          <div class="meter-header">
            <span>Confiança</span>
            <span>{{ confidence() }}%</span>
          </div>
          <div class="progress-line">
            <div class="fill" [style.width.%]="confidence()"></div>
          </div>
        </div>
        <div class="meter">
          <div class="meter-header">
            <span>Progresso</span>
            <span>{{ practiceProgress() }}%</span>
          </div>
          <div class="progress-line">
            <div class="fill" [style.width.%]="practiceProgress()"></div>
          </div>
        </div>
      </div>

      @if (practiceProgress() === 100) {
        <div class="completion-banner soft-card soft-card--spacious" role="status">
          <div class="title">Concluído! +{{ lesson()?.xpReward }} XP</div>
          <div class="desc">Excelente trabalho. Você pode continuar praticando ou voltar ao módulo.</div>
          <div class="actions">
            <button class="btn ghost" (click)="backToLesson()">Voltar à lição</button>
            @if (nextLessonId()) {
              <button class="btn primary" (click)="goToNextLesson()">Próxima lição</button>
              <button class="btn ghost" (click)="backToModule()">Voltar ao módulo</button>
            } @else {
              <button class="btn primary" (click)="backToModule()">Voltar ao módulo</button>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading">Carregando…</div>
</ng-template>
