<div class="dashboard">
  @if (isLoading()) {
    <div class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Carregando sua jornada...</div>
    </div>
  } @else {
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-title">
          <div class="title-wrapper">
            <h1>Minhas Lições</h1>
          </div>
        </div>
        <div class="header-actions">
          <div class="stat stat-xp">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="#fbbf24"/>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-label">Pontuação</span>
              <span class="stat-value">{{ profile()?.totalXp ?? 0 }} XP</span>
            </div>
          </div>
          <div class="stat stat-progress">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="#7c3aed" stroke-width="2" fill="none" opacity="0.3"/>
                <circle 
                  cx="12" 
                  cy="12" 
                  r="10" 
                  stroke="#7c3aed" 
                  stroke-width="2" 
                  fill="none"
                  stroke-linecap="round"
                  [attr.stroke-dasharray]="62.83"
                  [attr.stroke-dashoffset]="62.83 * (1 - overallStats().progress)"
                  style="transform: rotate(-90deg); transform-origin: center;"
                />
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-label">Progresso Geral</span>
              <div class="progress-wrapper">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="overallStats().progress * 100"></div>
                </div>
                <span class="progress-text">
                  {{ overallStats().completedLessons }}/{{ overallStats().totalLessons }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress Charts removed per request -->

      <!-- Modules Grid -->
      <div class="modules-grid">
        @for (module of modules(); track module.id) {
          <div class="module-card"
            [class.locked]="isModuleLocked(module)"
            [title]="isModuleLocked(module) ? getModuleLockReason(module) : 'Escolha uma lição para praticar'">
            <div class="module-header">
              <div class="module-icon-wrapper">
                <div class="module-icon">
                  <!-- Ícones desativados temporariamente -->
                </div>
              </div>
              <div class="module-info">
                <h2>{{ module.title }}</h2>
                <p class="module-desc">{{ module.description }}</p>
                <span class="levels-count">{{ getLessonsForModule(module.id).length }} lições</span>
              </div>
            </div>

            <div class="module-progress">
              <div class="progress-header">
                <span>Progresso:</span>
                <span>{{ getCompletedLessonsForModule(module.id) }}/{{ getTotalLessonsForModule(module.id) }}</span>
              </div>
              <div class="progress-line">
                <div class="fill" [style.width.%]="getModuleProgressPercent(module.id)"></div>
              </div>
            </div>

            @if (getModuleGroups(module.id).length > 1) {
              <div class="alphabet-groups">
                <div class="group-tabs">
                  @for (group of getModuleGroups(module.id); let gi = $index; track group.label) {
                    <button
                      class="tab-pill"
                      [class.active]="getActiveGroup(module.id) === gi"
                      [disabled]="isModuleLocked(module) || !isGroupUnlocked(module.id, gi)"
                      [title]="isModuleLocked(module) ? getModuleLockReason(module) : (!isGroupUnlocked(module.id, gi) ? getGroupLockReason(module.id, gi) : group.label)"
                      (click)="$event.stopPropagation(); setActiveGroup(module.id, gi)"
                    >{{ group.label }}</button>
                  }
                </div>
                <div class="alphabet-group soft-card soft-card--compact fade-in">
                  <div class="group-header">
                    <span class="badge badge-neutral">{{ getModuleGroups(module.id)[getActiveGroup(module.id)].label }}</span>
                    <div class="progress-line" style="width: 6rem;">
                      <div class="fill" [style.width.%]="getGroupProgressPercent(module.id, getActiveGroup(module.id))"></div>
                    </div>
                  </div>
                  <div class="levels-list">
                    @for (lesson of getModuleGroups(module.id)[getActiveGroup(module.id)].lessons; track lesson.id; let j = $index) {
                      <button
                        type="button"
                        class="level-btn"
                        [class.unlocked]="!isModuleLocked(module) && isLessonUnlocked(module.id, getModuleGroupBaseIndex(module.id, getActiveGroup(module.id)) + j)"
                        [class.locked]="isModuleLocked(module) || !isLessonUnlocked(module.id, getModuleGroupBaseIndex(module.id, getActiveGroup(module.id)) + j)"
                        [disabled]="isModuleLocked(module) || !isLessonUnlocked(module.id, getModuleGroupBaseIndex(module.id, getActiveGroup(module.id)) + j)"
                        (click)="$event.stopPropagation(); !isModuleLocked(module) && isLessonUnlocked(module.id, getModuleGroupBaseIndex(module.id, getActiveGroup(module.id)) + j) && handleLessonClick(module.id, lesson.id)"
                        [title]="lesson.displayName">
                            <span class="level-number">{{ getModuleGroupBaseIndex(module.id, getActiveGroup(module.id)) + j + 1 }}</span>
                      </button>
                    }
                  </div>
                </div>
              </div>
            } @else {
              <div class="levels-list">
                @for (lesson of getLessonsForModule(module.id); track lesson.id; let i = $index) {
                  <button
                    type="button"
                    class="level-btn"
                    [class.unlocked]="!isModuleLocked(module) && getModuleProgress(module.id) >= i"
                    [class.locked]="isModuleLocked(module) || getModuleProgress(module.id) < i"
                    [disabled]="isModuleLocked(module) || getModuleProgress(module.id) < i"
                    (click)="$event.stopPropagation(); !isModuleLocked(module) && getModuleProgress(module.id) >= i && handleLessonClick(module.id, lesson.id)"
                    [title]="lesson.displayName">
                    <span class="level-number">{{ i + 1 }}</span>
                  </button>
                }
              </div>
            }
          </div>
        }

        @if (modules().length === 0) {
          <div class="empty-state">
            Nenhum conteúdo disponível ainda. Importe módulos ou crie lições para começar.
          </div>
        }
      </div>
    </div>
  }
</div>
